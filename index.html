<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Page Stripper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .input-group {
            margin-bottom: 15px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #output {
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            padding: 3px;
            border-radius: 3px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
            margin-bottom: 10px;
        }
        .progress {
            display: block;
            height: 22px;
            background-color: #659cef;
            border-radius: 3px;
            transition: width 500ms ease-in-out;
        }
        .results-summary {
            display: flex;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .results-summary div {
            text-align: center;
        }
        .results-summary h3 {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .results-summary p {
            margin: 5px 0 0;
            font-size: 24px;
            font-weight: bold;
        }
        .pages-kept p {
            color: #2e7d32;
        }
        .pages-removed p {
            color: #c62828;
        }
        .pages-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .page-chip {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        .page-kept {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .page-removed {
            background-color: #ffcdd2;
            color: #c62828;
        }
        #pdfCreationStatus {
            margin-top: 10px;
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .info-icon {
            display: inline-block;
            width: 15px; /* Reduced size */
            height: 15px;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px; /* Smaller text */
            line-height: 15px;
            cursor: pointer;
            margin-left: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Page Stripper (Powerpoint Slides)<span class="info-icon" onclick="showInfo()">i</span></h1>
        <p>This tool removes pages that contain all words from the previous page, effectively stripping out incremental slides.</p>
        <div class="input-group">
            <input type="file" id="fileInput" accept=".pdf" multiple>
        </div>
        <button onclick="processFiles()">Process PDFs</button>
        <button id="downloadBtn" onclick="downloadProcessedPDFs()" style="display: none; margin-left: 10px;">Download Processed PDFs</button> <!-- Added margin for space -->
        <div class="progress-bar" style="display: none;">
            <span class="progress" style="width: 0%"></span>
        </div>
        <div id="pdfCreationStatus"></div>
        <hr style="display: none;" id="resultSeparator"/> <!-- Separator after status -->
        <div id="output"></div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInfo()">&times;</span>
            <h2>How it works</h2>
            <p>This tool processes PDF files by comparing the text content of each page:</p>
            <ul>
                <li>It extracts the text from each page of the PDF.</li>
                <li>It compares the current page with the previous page.</li>
                <li>If the current page contains all the words from the previous page, the previous page is removed.</li>
                <li>This process effectively removes incremental slides, keeping only the final version of each slide.</li>
                <li>The tool can process multiple PDF files at once.</li>
                <li>After processing, you can download a ZIP file containing all processed PDFs.</li>
            </ul>
            <p>Note: This tool only compares text content. It does not analyze images or layouts.</p>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.querySelector('.progress-bar');
        const progress = document.querySelector('.progress');
        const pdfCreationStatus = document.getElementById('pdfCreationStatus');
        const resultSeparator = document.getElementById('resultSeparator'); // Separator element

        let processedPDFs = [];

        async function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Please select at least one PDF file.');
                return;
            }

            progressBar.style.display = 'block';
            downloadBtn.style.display = 'none';
            pdfCreationStatus.textContent = 'Processing PDFs...';

            processedPDFs = [];
            let outputHtml = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const result = await processPDF(file);
                processedPDFs.push({ name: file.name, pdf: result.pdf });
                outputHtml += result.html;

                progress.style.width = `${((i + 1) / files.length) * 100}%`;
            }

            document.getElementById('output').innerHTML = outputHtml;
            progressBar.style.display = 'none';
            pdfCreationStatus.textContent = 'All PDFs processed successfully!';
            resultSeparator.style.display = 'block'; // Show separator after processing
            downloadBtn.style.display = 'inline-block';
        }

        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const numPages = pdf.numPages;
            let pagesToKeep = [];
            let allPages = [];

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');

                allPages.push({ pageNumber: i, text: pageText });

                if (pagesToKeep.length === 0 || !includesAllWords(pageText, pagesToKeep[pagesToKeep.length - 1].text)) {
                    pagesToKeep.push({ pageNumber: i, text: pageText });
                } else {
                    pagesToKeep.pop();
                    pagesToKeep.push({ pageNumber: i, text: pageText });
                }
            }

            const processedPDF = await createProcessedPDF(file, pagesToKeep);
            const html = displayResults(file.name, pagesToKeep, allPages);

            return { pdf: processedPDF, html: html };
        }

        function includesAllWords(currentText, previousText) {
            const currentWords = new Set(currentText.toLowerCase().split(/\s+/));
            const previousWords = new Set(previousText.toLowerCase().split(/\s+/));

            for (let word of previousWords) {
                if (!currentWords.has(word)) {
                    return false;
                }
            }
            return true;
        }

        function displayResults(fileName, pagesToKeep, allPages) {
            const keptPageNumbers = new Set(pagesToKeep.map(p => p.pageNumber));
            const removedPages = allPages.length - pagesToKeep.length;
            
            let html = `<h2>${fileName}</h2>`;
            html += `
                <div class="results-summary">
                    <div>
                        <h3>Total Pages</h3>
                        <p>${allPages.length}</p>
                    </div>
                    <div>
                        <h3>Pages Kept</h3>
                        <p>${pagesToKeep.length}</p>
                    </div>
                    <div>
                        <h3>Pages Removed</h3>
                        <p>${removedPages}</p>
                    </div>
                </div>
            `;
            html += `<h3>Page breakdown:</h3>`;
            html += `<div class="pages-list">`;
            for (let page of allPages) {
                const chipClass = keptPageNumbers.has(page.pageNumber) ? 'page-kept' : 'page-removed';
                html += `<span class="page-chip ${chipClass}">Page ${page.pageNumber}</span>`;
            }
            html += `</div>`;
            
            return html;
        }

        async function createProcessedPDF(file, pagesToKeep) {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            const newPdfDoc = await PDFLib.PDFDocument.create();

            for (const page of pagesToKeep) {
                const [copiedPage] = await newPdfDoc.copyPages(pdfDoc, [page.pageNumber - 1]);
                newPdfDoc.addPage(copiedPage);
            }

            return await newPdfDoc.save();
        }

        async function downloadProcessedPDFs() {
            if (processedPDFs.length === 1) {
                pdfCreationStatus.textContent = 'Creating PDF...';
                await new Promise(resolve => setTimeout(resolve, 100)); // Allow UI to update
                const pdfFile = processedPDFs[0];
                download(pdfFile.pdf, pdfFile.name, 'application/pdf');
                pdfCreationStatus.textContent = 'PDF downloaded successfully!';
            } else {
                pdfCreationStatus.textContent = 'Creating ZIP file...';
                await new Promise(resolve => setTimeout(resolve, 100)); // Allow UI to update
                const zip = new JSZip();

                for (const pdfFile of processedPDFs) {
                    zip.file(pdfFile.name, pdfFile.pdf);
                }

                const content = await zip.generateAsync({ type: 'blob' });
                download(content, 'processed_pdfs.zip', 'application/zip');
                pdfCreationStatus.textContent = 'ZIP file downloaded successfully!';
            }
        }

        function showInfo() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfo() {
            document.getElementById('infoModal').style.display = 'none';
        }
    </script>
</body>
</html>
