<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced PDF Page Stripper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #similarityThreshold {
            flex-grow: 1;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #output {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        #downloadBtn {
            display: none;
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            padding: 3px;
            border-radius: 3px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, .2);
            margin-bottom: 10px;
        }
        .progress {
            display: block;
            height: 22px;
            background-color: #659cef;
            border-radius: 3px;
            transition: width 500ms ease-in-out;
        }
        .results-summary {
            display: flex;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .results-summary div {
            text-align: center;
        }
        .results-summary h3 {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .results-summary p {
            margin: 5px 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .pages-kept {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .page-chip {
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        #pdfCreationStatus {
            display: none;
            margin-top: 10px;
            text-align: center;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced PDF Page Stripper</h1>
        <p>This tool removes similar pages from a PDF and allows you to download the processed file.</p>
        <div class="input-group">
            <input type="file" id="fileInput" accept=".pdf">
        </div>
        <div class="input-group slider-container">
            <label for="similarityThreshold">Similarity Threshold:</label>
            <input type="range" id="similarityThreshold" min="0.5" max="1" step="0.01" value="0.9">
            <span id="thresholdValue">0.9</span>
        </div>
        <button onclick="processPDF()">Process PDF</button>
        <div class="progress-bar" style="display: none;">
            <span class="progress" style="width: 0%"></span>
        </div>
        <div id="pdfCreationStatus"></div>
        <button id="downloadBtn" onclick="downloadProcessedPDF()">Download Processed PDF</button>
        <div id="output"></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const similarityThresholdSlider = document.getElementById('similarityThreshold');
        const thresholdValueSpan = document.getElementById('thresholdValue');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.querySelector('.progress-bar');
        const progress = document.querySelector('.progress');
        const pdfCreationStatus = document.getElementById('pdfCreationStatus');

        let processedPDF = null;

        similarityThresholdSlider.addEventListener('input', function() {
            thresholdValueSpan.textContent = this.value;
        });

        async function processPDF() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a PDF file.');
                return;
            }

            progressBar.style.display = 'block';
            downloadBtn.style.display = 'none';
            pdfCreationStatus.style.display = 'none';

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const numPages = pdf.numPages;
            let pagesToKeep = [];

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');

                if (i === 1 || !isSimilarToLastKeptPage(pageText, pagesToKeep[pagesToKeep.length - 1])) {
                    pagesToKeep.push({ pageNumber: i, text: pageText });
                }

                progress.style.width = `${(i / numPages) * 100}%`;
            }

            displayResults(pagesToKeep, numPages);
            
            progressBar.style.display = 'none';
            pdfCreationStatus.style.display = 'block';
            pdfCreationStatus.textContent = 'Creating processed PDF...';
            
            await createProcessedPDF(file, pagesToKeep);
            
            pdfCreationStatus.textContent = 'Processed PDF created successfully!';
            downloadBtn.style.display = 'block';
        }

        function isSimilarToLastKeptPage(currentText, lastKeptPage) {
            if (!lastKeptPage) return false;

            const lastText = lastKeptPage.text;
            const similarityThreshold = parseFloat(document.getElementById('similarityThreshold').value);

            const currentWords = new Set(currentText.toLowerCase().split(/\s+/));
            const lastWords = new Set(lastText.toLowerCase().split(/\s+/));

            const intersection = new Set([...currentWords].filter(x => lastWords.has(x)));
            const union = new Set([...currentWords, ...lastWords]);

            const similarity = intersection.size / union.size;

            const containsAllLastWords = [...lastWords].every(word => currentWords.has(word));

            return containsAllLastWords && 
                   similarity >= similarityThreshold && 
                   currentWords.size > lastWords.size;
        }

        function displayResults(pagesToKeep, totalPages) {
            const output = document.getElementById('output');
            const removedPages = totalPages - pagesToKeep.length;
            
            let html = `<h2>Results</h2>`;
            html += `
                <div class="results-summary">
                    <div>
                        <h3>Total Pages</h3>
                        <p>${totalPages}</p>
                    </div>
                    <div>
                        <h3>Pages Kept</h3>
                        <p>${pagesToKeep.length}</p>
                    </div>
                    <div>
                        <h3>Pages Removed</h3>
                        <p>${removedPages}</p>
                    </div>
                </div>
            `;
            html += `<h3>Pages kept:</h3>`;
            html += `<div class="pages-kept">`;
            for (let page of pagesToKeep) {
                html += `<span class="page-chip">Page ${page.pageNumber}</span>`;
            }
            html += `</div>`;
            
            output.innerHTML = html;
        }

        async function createProcessedPDF(file, pagesToKeep) {
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            const newPdfDoc = await PDFLib.PDFDocument.create();

            for (const page of pagesToKeep) {
                const [copiedPage] = await newPdfDoc.copyPages(pdfDoc, [page.pageNumber - 1]);
                newPdfDoc.addPage(copiedPage);
            }

            processedPDF = await newPdfDoc.save();
        }

        function downloadProcessedPDF() {
            if (processedPDF) {
                const fileName = 'processed_' + document.getElementById('fileInput').files[0].name;
                download(processedPDF, fileName, "application/pdf");
            } else {
                alert('Please process a PDF file first.');
            }
        }
    </script>
</body>
</html>